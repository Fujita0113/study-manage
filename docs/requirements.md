# 学習管理アプリケーション 要件定義書

**データモデル詳細**: [data-model.md](./data-model.md) を参照

---

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2026-02-10 | ホーム画面の当日カードクリック時に編集画面へ遷移するよう変更 |
| 2026-02-08 | 日報編集機能の追加 |
| 2026-02-04 | リカバリーモード機能の追加 |
| 2026-02-04 | 日報記録画面：Bronze未達成でも自由記述のみで記録可能に変更 |
| 2026-02-04 | 昨日の日報未作成バナー機能の追加 |
| 2025-01-25 | 目標のTODOリスト化、「その他」TODOカテゴリ追加、日報登録画面のUI変更 |

---

## 1. 認証機能（Authentication）

学習記録を個人ごとに管理するため、ログイン・サインアップ機能を実装します。

### 認証方式

- **認証プロバイダー**: Supabase Auth（メール＋パスワード）
- **認証方法**: メールアドレスとパスワードでサインアップ・ログイン

### サインアップ画面

新規ユーザーがアカウントを作成する画面です。

- **入力項目**:
    - メールアドレス（必須）
    - パスワード（必須、8文字以上）
    - パスワード確認（必須、パスワードと一致必須）
- **バリデーション**:
    - メールアドレス形式のチェック
    - パスワードの長さチェック（8文字以上）
    - パスワードと確認用パスワードの一致チェック
- **サインアップボタン**:
    - 押下でSupabaseにアカウント作成リクエスト
    - 成功時はメール確認の案内を表示
    - エラー時は適切なエラーメッセージを表示
- **ログイン画面へのリンク**: 既にアカウントを持っている場合はログイン画面へ遷移

### メール確認

- Supabaseから確認メールが送信される
- ユーザーはメール内のリンクをクリックして認証を完了
- 確認完了後、ログイン画面へ誘導

### ログイン画面

既存ユーザーがログインする画面です。

- **入力項目**:
    - メールアドレス（必須）
    - パスワード（必須）
- **ログインボタン**:
    - 押下でSupabaseに認証リクエスト
    - 成功時はホーム画面（ダッシュボード）へ遷移
    - エラー時は適切なエラーメッセージを表示（「メールアドレスまたはパスワードが間違っています」）
- **サインアップ画面へのリンク**: アカウントを持っていない場合はサインアップ画面へ遷移
- **パスワードリセットリンク**: パスワードを忘れた場合はパスワードリセット画面へ遷移

### パスワードリセット画面

パスワードを忘れたユーザーがパスワードをリセットする画面です。

- **入力項目**:
    - メールアドレス（必須）
- **リセットメール送信ボタン**:
    - 押下でSupabaseにパスワードリセットメール送信リクエスト
    - 成功時は「リセットメールを送信しました」と表示
    - エラー時は適切なエラーメッセージを表示
- **ログイン画面へのリンク**: ログイン画面に戻る

### ログアウト機能

- **設定画面にログアウトボタンを追加**
- 押下でSupabaseからログアウト
- ログアウト後はログイン画面へ遷移

### 認証状態の管理

- **未認証ユーザーのアクセス制御**:
    - 未認証ユーザーは全ての画面にアクセスできない
    - 自動的にログイン画面へリダイレクト
- **認証済みユーザー**:
    - 全ての機能にアクセス可能
    - ユーザーIDに紐づいた学習記録のみを表示

### 初回ログイン時のフロー

- 初回ログイン時は、目標の有無で初期設定が必要かどうかを判定
- 目標が未設定（Bronze/Silver/Goldのいずれか1つでも未設定）の場合は、**初期目標設定画面へ自動遷移**
- すべての目標が設定済みの場合は、通常のホーム画面へ遷移

### 初期目標設定画面

初回ログイン時に、Bronze/Silver/Goldの3つの目標（各目標は1つ以上のTODO）を設定する画面です。

**アクセス条件**:
- ログイン直後、目標が未設定の場合に自動的に遷移
- 目標が1つでも未設定の場合はこの画面を表示
- サイドバーやナビゲーションからは直接アクセス不可（初回のみ）

**画面構成**:
- **タイトル**: 「目標を設定しましょう」
- **説明文**: 「学習を続けるために、3つのレベルの目標を設定します。Bronze（最低限）、Silver（計画通り）、Gold（期待以上）の順に設定してください。各レベルには複数のTODOを設定できます。」
- **入力フォーム**:
  - **Gold目標**: TODOリスト形式（必須、最低1つ）
    - 各TODO: テキスト入力
    - 「+ TODOを追加」ボタンで項目を追加可能（上限なし）
    - プレースホルダー: 「例：リファクタリングまで完了する」
  - **Silver目標**: TODOリスト形式（必須、最低1つ）
    - 各TODO: テキスト入力
    - 「+ TODOを追加」ボタンで項目を追加可能（上限なし）
    - プレースホルダー: 「例：1機能を完成させる」
  - **Bronze目標**: TODOリスト形式（必須、最低1つ）
    - 各TODO: テキスト入力
    - 「+ TODOを追加」ボタンで項目を追加可能（上限なし）
    - プレースホルダー: 「例：30分だけ座って作業する」
  - **リカバリー目標**: 1つのシンプルな目標（必須）
    - テキスト入力（1行）
    - プレースホルダー: 「例：サウナに行く」
    - 説明文: 「調子が悪い日に実行する回復アクションを設定してください」
- **保存ボタン**: 「目標を保存して開始」
  - 各レベルに最低1つのTODOが入力されている場合のみ有効化
  - リカバリー目標も1文字以上の入力が必要
  - 押下で目標をデータベースに保存し、ホーム画面へ遷移

**バリデーション**:
- 各レベル（Bronze/Silver/Gold）に最低1つのTODOが必要
- 各TODOは最低1文字以上の入力が必要
- リカバリー目標は1文字以上の入力が必要
- 空のTODO項目は保存時に自動的に除外

**保存時の処理**:
1. 3つの目標を登録（Bronze/Silver/Gold）
2. 各目標のTODOを登録
3. リカバリー目標を登録
4. 目標履歴の初期スロットを作成
5. 保存完了後、ホーム画面へ自動遷移

---

## 2. 共通レイアウト（Layout）

|**項目**|**種別**|**内容・機能**|
|---|---|---|
|**ヘッダー：ストリーク**|表示|現在の連続記録日数（例：`🔥 12 days`）を表示。日報が記録されている日を連続でカウント（達成レベルは問わない）。**当日の記録がまだない場合は、昨日までの連続記録日数を表示する。** 記録をしなかった日（当日を除く）があった場合はリセットされる。ストリーク日数は`daily_records`テーブルから動的に計算される。|
|**ヘッダー：記録ボタン**|ボタン|**最重要アクション。** 押下で「記録画面」へ遷移。|
|**ヘッダー：リカバリーボタン**|ボタン|「記録」ボタンの横に配置。押下で「リカバリーモード」を起動。当日の記録が確定済みの場合は非表示。|
|**提案バナー**|通知|画面右下に固定表示される通知形式のバナー。条件を満たした場合のみ表示され、×ボタンで閉じることができる。|

---

## 2. ホーム画面（Dashboard）

「過去の学習履歴」を一覧し、モチベーションを維持する画面です。

### デイリーレポートカード一覧

過去の学習記録をグリッド形式（2-3列）で表示します。新しい順（今日が最上位）に並びます。

#### カードの構成要素

各カードには以下の情報を表示：

- **日付**: 「2025年12月31日（火）」形式で表示

- **達成度バッジ**: Bronze / Silver / Gold / 未記録 のいずれかを色付きバッジで表示

- **達成TODO一覧**:

    - その日に達成したTODO（目標TODO＋その他TODO）を箇条書き形式で表示

    - 最大3件まで表示し、4件以上ある場合は「もっと見る」リンクを表示

    - 各TODOの前にチェックマーク（✅）を表示

    - 達成TODOがない場合は「達成項目なし」と表示

- **日報の抜粋**:

    - 自由記述（Journal）がある場合、冒頭100文字程度を表示

    - ない場合は「日報なし」と表示

- **カードクリック**: カード全体がクリッカブル。遷移先は日付によって異なる：
  - **当日のカード**: 記録画面（編集モード）へ遷移。既存の記録内容を読み込んで表示し、当日中（23:59:59まで）は内容を編集して保存できる
  - **過去のカード**: その日の「日詳細画面（読み取り専用）」へ遷移


#### 表示件数とレイアウト

- グリッド表示: PC画面で見栄えが良いように2-3列のグリッドレイアウトで表示
- 初期表示: 直近の記録を表示（PCで最適な表示となる日数）


### 提案バナー（共通レイアウト）

画面右下に固定表示される通知形式のバナーです。条件を満たした場合のみ表示されます。

- **表示位置**: 画面右下に固定
- **閉じる機能**: ×ボタンで閉じることができる
- **メッセージ**: 「レベルアップの条件を満たしました」or「目標をレベルダウンしませんか？」等のテキスト
- **アクションボタン**: 押下で「目標編集画面」へ遷移

#### 表示条件と編集権限
- **レベルアップ提案**:
    - **Gold を14日連続達成**: Gold目標のみ編集可能
    - **Silver を14日連続達成**: Silver目標のみ編集可能
    - **Bronze を14日連続達成**: Bronze目標のみ編集可能
    - **注意**: 「14日連続達成」とは、ちょうど14日目、28日目、42日目...（14の倍数日）を意味します。15日目、16日目など14の倍数でない日は提案バナーを表示しません。
- **レベルダウン提案**: 1週間のうち、Bronzeすら4日以上達成できなかった場合（全目標の編集が可能）

#### 表示期間と再表示ルール
- **表示期間**: 条件を達成した当日のみ表示。日付が変わると自動的に非表示になる
  - 例：1月13日に14日連続達成（14日目）→  1月13日のみ提案バナー表示、1月14日（15日目）からは非表示
- **再表示条件**: ユーザーが提案を無視（レベル変更しない）した場合でも、再度14日連続を達成すれば再び提案バナーを表示する
  - 例1: Bronze→Silver提案を無視 → さらに14日連続達成（合計28日連続）→ 28日目に再度Bronze→Silver提案が表示される
  - 例2: 14日目に提案表示 → 15日目は非表示 → ... → 28日目に再度提案表示

### 昨日の日報未作成バナー（共通レイアウト）

昨日の日報が作成されていない場合に、ホーム画面に表示される通知バナーです。

- **表示位置**: 画面右下に固定（提案バナーと同じ位置）
- **閉じる機能**: なし（日報を作成するまで常に表示）
- **メッセージ**: 「昨日の日報が作成されていません。日報を作成しますか？」
- **アクションボタン**: 押下で「記録画面」へ遷移（日付は昨日に設定）

#### 表示条件
- **昨日の日報が未作成**: `daily_records`テーブルに昨日の日付のレコードが存在しない場合に表示
- **昨日の日報が作成済み**: バナーは非表示

#### 提案バナーとの併存ルール
- 提案バナー（レベルアップ/ダウン提案）と昨日の日報未作成バナーは**両方同時に表示可能**
- **配置**: 縦に並べて表示（提案バナーの上または下に昨日の日報未作成バナーを配置）
- **デザイン**: 既存の提案バナーと同じスタイルを使用

#### 遷移先
- アクションボタン押下で「記録画面」へ遷移
- 遷移時、日付は**昨日**に自動設定される
- 記録画面のURLは `/record?date=YYYY-MM-DD` 形式（YYYYMMDDは昨日の日付）

---
## 3. 記録・日報画面（Daily Recording & Editing）

その日の学習成果を記録し、振り返りを行う画面です。当日中であれば既存の日報を編集することも可能です。

### アクセス方法と動作

- **ヘッダー/サイドバーの「記録」ボタンから遷移**:
  - 当日の日報が未作成の場合：新規作成モードで開く
  - 当日の日報が既に存在する場合：編集モードで開く（既存データを読み込んで表示）
  - **編集可能期間**: 記録日の当日中（23:59:59まで）
  - **日付が変わった場合**: 編集不可となり、読み取り専用になる

### 新規作成モードと編集モードの違い

- **新規作成モード**:
  - 全てのTODOチェックが空の状態
  - 自由記述（Journal）が空の状態
  - ボタンは「記録を確定してロックする」と表示

- **編集モード**:
  - 既存のTODOチェック状態を読み込んで表示
  - 既存の自由記述（Journal）を読み込んで表示
  - ボタンは「変更を保存する」と表示
  - 編集可能期間外（翌日以降）の場合は、全てのフィールドが読み取り専用になる

### 目標達成度（TODOチェックリスト形式）

その日の実際の達成度をTODOのチェックで記録します。各レベルの全TODOを達成すると、そのレベルが達成となります。

**表示形式**:
```
## ☐ Recovery（リカバリーモード中のみ表示）
- [ ] サウナに行く

## ☐ Gold（チェックすると配下の全TODOにチェックが入る）
- [ ] リファクタリングまで完了する
- [ ] コードレビューを受ける

## ☐ Silver（チェックすると配下の全TODOにチェックが入る）
- [ ] 1機能を完成させる

## ☐ Bronze（チェックすると配下の全TODOにチェックが入る）
- [ ] 30分だけ座って作業する
- [ ] 朝の散歩をする

## その他
✅ 買い物に行く
✅ メール返信
+ [テキストボックス]  ← 新しいTODOを追加
```

#### Recoveryセクション（リカバリーモード中のみ）
- **表示条件**: リカバリーモードが起動中の場合のみ表示
- **表示位置**: 記録画面の最上部（Goldの上）
- **内容**: ユーザーが設定したリカバリー目標を1つ表示
- **チェック動作**: チェックを入れるとRecovery達成として記録される

#### レベル見出しのチェック動作
- **レベル見出し（Gold/Silver/Bronze）をチェック**: 配下の全TODOに一括でチェックが入る
- **レベル見出しのチェックを外す**: 配下の全TODOのチェックが一括で外れる
- **個別TODOのチェック/チェック解除**: そのTODOのみに影響

#### 達成レベルの判定
- **Recovery達成**: リカバリーモード中にRecovery目標にチェックが入っている状態
- **Gold達成**: Goldの全TODOにチェックが入っている状態
- **Silver達成**: Silverの全TODOにチェックが入っている状態
- **Bronze達成**: Bronzeの全TODOにチェックが入っている状態
- **未達成**: いずれのレベルも全TODO達成していない状態
- **最終達成レベル**: 達成したレベルのうち最も高いレベル（Gold > Silver > Bronze）
- **Recovery + 通常レベル**: リカバリーモード中は、Recovery達成と通常レベル（Bronze/Silver/Gold）の両方を記録可能

**注意**: Bronze/Silver/Goldは完全独立です。Gold達成にBronze/Silverの達成は必要ありません。
**注意**: Recovery達成でストリークは維持されます。さらにBronze以上も達成した場合は両方記録されます。

### その他TODO

目標レベル（Gold/Silver/Bronze）とは別に、日々の達成項目を記録できる「その他」カテゴリです。

#### 特徴
- 達成度（Bronze/Silver/Gold）の判定には**影響しない**
- 一度登録したTODOは**次回以降の日報登録でも表示**される（永続化）
- いつでも**アーカイブ可能**（非表示にするだけ、過去記録は保持）

#### 追加方法
- 「その他」セクションのテキストボックスに入力
- Enterキーまたは追加ボタンでTODOとして登録
- 登録と同時にその日の達成としてチェックが入る

#### 表示順
- 最後に達成した日付順（新しい順）

#### オートコンプリート機能
- テキストボックス入力時、既存のTODO（アーカイブ済み含む）から候補を表示
- 候補を選択すると、アーカイブ済みの場合は自動的に復活

#### アーカイブ
- 各「その他」TODOにはアーカイブボタン（ゴミ箱アイコンなど）を表示
- アーカイブすると日報登録画面から非表示になる
- 過去の達成記録は保持される
- オートコンプリートで同名入力時に復活可能

### 自由記述（Journal）

- **内容**: 今日感じたこと、学んだこと、自分への褒め言葉など
- **入力形式**: テキストエリア
- **必須条件**:
  - Bronzeの全TODOが達成されている場合：任意
  - Bronzeの全TODOが達成されていない場合：**必須**（1文字以上の入力が必要）

---

### アクションボタン

- **新規作成モード**: **[ 記録を確定してロックする ]**
    - ※保存後、今日の記録は編集可能な状態でダッシュボードへ遷移します。

- **編集モード**: **[ 変更を保存する ]**
    - ※保存後、変更内容が反映され、ダッシュボードへ遷移します。

### 記録/保存ボタンの有効条件

ボタンは以下のいずれかの条件を満たす場合に有効化されます：

1. **Bronzeの全TODOが達成されている**（従来通り）
2. **自由記述が1文字以上入力されている**（Bronze未達成でも記録可能）
3. **リカバリーモード中でRecovery目標が達成されている**（Recovery達成で記録可能）

### 保存時の処理

1. 各TODOの達成状態を保存（更新）
2. 最終達成レベルを保存（更新）（Bronze未達成の場合は「none」）
3. リカバリーモード中の場合、Recovery達成状態を保存
4. 新規追加された「その他」TODOを登録
5. リカバリーモードを解除（リカバリーモード中の場合）

### 編集制限

- **当日中（記録日の23:59:59まで）**: すべての内容を編集可能
  - TODOチェック状態（Recovery/Gold/Silver/Bronze/その他）
  - 自由記述（Journal）
  - リカバリーモードの起動状態（編集不可、新規作成時のみ設定可能）

- **日付が変わった後（翌日以降）**: 完全に読み取り専用
  - 全てのフィールドが編集不可
  - 保存ボタンは非表示
  - 「この日報は編集期限が過ぎています」とメッセージを表示
        

---


## 4. 目標編集画面（Goal Adjustment）

**提案バナー経由でのみアクセス可能**。「目標そのもの」を書き換える画面です。

### アクセス条件

- **レベルアップ提案時（14日連続達成）**: 提案バナーのボタンから遷移可能
- **レベルダウン提案時（7日中4日未達）**: 提案バナーのボタンから遷移可能
- **上記以外**: 目標編集画面へのアクセスは不可（編集ロック状態）

### 編集入力フォーム

各レベルの目標をTODOリスト形式で編集します。

- **Gold目標**: TODOリスト形式
  - 既存のTODO一覧を表示（編集・削除可能）
  - 「+ TODOを追加」ボタンで新規項目を追加可能（上限なし）
  - 各TODOは最低1文字以上
  - 最低1つのTODOが必要

- **Silver目標**: TODOリスト形式
  - 既存のTODO一覧を表示（編集・削除可能）
  - 「+ TODOを追加」ボタンで新規項目を追加可能（上限なし）
  - 各TODOは最低1文字以上
  - 最低1つのTODOが必要

- **Bronze目標**: TODOリスト形式
  - 既存のTODO一覧を表示（編集・削除可能）
  - 「+ TODOを追加」ボタンで新規項目を追加可能（上限なし）
  - 各TODOは最低1文字以上
  - 最低1つのTODOが必要

### 更新ボタン

- 入力した内容を新しい基準として保存
- 保存時、現在の目標期間（スロット）が確定し、新しい目標期間が開始される
- 目標変遷画面のタイムラインに新しいスロットが追加される
- 各目標のTODOリストが新しい内容で更新される

---

## 5. 目標変遷画面（Goal Progress Race）

目標（Bronze/Silver/Gold）の成長プロセスを、**デッドヒート形式の横棒グラフアニメーション**で可視化する画面です。**各目標レベル（Bronze/Silver/Gold）は独立して管理され**、それぞれが「レベル（Lv.）」を持ち、14日連続達成でレベルアップ・目標内容が更新されます。過去から現在までの成長の軌跡を、まるで登録者数が増えていくような高揚感とともに体験できます。

### アクセス方法

- サイドバーのメニュー項目「目標変遷」から遷移
- メニュー順序: ホーム → 記録 → カレンダー → 目標変遷 → 設定

### 画面構成要素

#### ① デッドヒート表示（横棒グラフ）

**レイアウト:**
- **縦軸**: Bronze、Silver、Goldの3行（すべて英語表記で統一）
- **横軸**: 0〜14日のカウント（ゲージ）
- **バーのラベル**: 各バーの左側に現在の目標内容を大きく表示（例：「Silver：120分」）
- **バーの色**: Bronze=銅色、Silver=銀色、Gold=金色（カラーパレット参照）

**バーの動き（アニメーション）:**
- アニメーションが始まると、実績データに基づいてバーが右に伸びていく
- 14日に到達すると「LEVEL UP!」エフェクトが発動し、バーが0にリセット
- 同時にラベルの目標内容が新しい内容に切り替わる（例：「Silver：120分」→「Silver：150分」）
- レベルダウン（目標調整）時は「ADJUST!」エフェクトが表示され、目標内容のみが静かに切り替わる（レベルは横ばい）
- アニメーションは過去から現在まで全履歴を通して再生される

#### ② レベル表示とバッジ

**現在のレベル表示:**
- 画面上部に各レベルの現在の到達レベルを表示（例：「Bronze Lv.3」「Silver Lv.7」「Gold Lv.14」）
- 各レベルは独立してカウントされる
- 表記は全てBronze/Silver/Goldの英語表記で統一

**レベル称号システム:**
- Bronze、Silver、Goldそれぞれが独立したレベル（Lv.）を持つ
- 14日連続達成ごとにそのレベルのLv.が1つ上がる
- レベルダウン（7日中4日未達による目標調整）時はレベルは横ばいのまま、目標内容のみ変更される

#### ③ 再生コントロール

**初期表示:**
- **画面を開いた時点では、最新（現在）の状態を静止画で表示**
- 現在のレベルと進捗状況が一目でわかるように、最終フレームの状態を表示
- ユーザーは画面を開いた瞬間に「今どの状態にいるか」を把握できる

**再生ボタン:**
- 画面下部に配置
- 押下でアニメーションが過去の初期状態から開始され、現在まで再生される
- 再生中は一時停止ボタンに切り替わる

**リセットボタン:**
- アニメーション終了後、再度最初から見たい場合に使用
- 押下で最初の状態に巻き戻る

**再生速度:**
- 標準速度で全履歴を再生
- ユーザーが途中で飽きないよう、適度なスピード感を保つ

#### ④ レベル履歴詳細モーダル

**アクセス方法:**
- 各バー（Bronze・Silver・Gold）のラベル部分をクリック
- モーダルウィンドウが開き、そのレベルの変遷履歴が表示される

**モーダルの表示内容:**
- **ヘッダー**: 「Bronzeの履歴」「Silverの履歴」「Goldの履歴」（英語表記で統一）
- **レベル履歴リスト**: そのレベルの全ての変遷を時系列で表示
  - 例：「Lv.1：15分」「Lv.2：30分」...「Lv.14：180分」
  - **レベルアップ/調整バッジの表示ルール**:
    - 前のカード（Lv.N）がレベルアップで終了した場合、次のカード（Lv.N+1）に「↗️ レベルアップ」バッジを表示
    - 前のカード（Lv.N）が目標調整で終了した場合、次のカード（Lv.N+1）に「↘️ 目標調整」バッジを表示
    - 最初のカード（Lv.1）にはバッジを表示しない（初期状態のため）
- **総達成率**: そのレベルの目標をどれくらい達成できていたかの割合
  - 計算式：「そのレベルの目標を達成した日数 ÷ そのレベルでの総日数」
  - 例：「Bronze目標達成率：85%（120日中102日達成）」
- **期間情報**: 各レベルがいつからいつまで有効だったかの期間表示

### インタラクション

- **初期表示**: 静止画として、現在の最新状態のバーとレベルを表示（ユーザーは画面を開いた瞬間に現在の状況を把握できる）
- **再生ボタン押下**: アニメーションが過去の初期状態から開始され、現在までの全履歴が再生される
- **リセットボタン押下**: アニメーションが最初の状態に巻き戻る
- **レベルラベルクリック**: モーダルが開き、そのレベルの詳細履歴と総達成率が表示される
- **初回起動時**: 履歴がない場合は「まだ目標変更履歴がありません」と表示

### アニメーション演出

**レベルアップ時（14日連続達成）:**
- バーが14日に到達した瞬間に「LEVEL UP!」エフェクトが画面に表示
- エフェクトの色：ポジティブな色（青や緑、光の演出）
- バーが0にリセットされる
- ラベルの目標内容が新しい内容に切り替わる（例：「中級：120分」→「中級：150分」）
- そのレベルのLv.が1つ上がる

**レベルダウン時（7日中4日未達による目標調整）:**
- 「ADJUST!」エフェクトが画面に表示される
- エフェクトの色：警告を示す色（オレンジや黄色）
- レベルは横ばいのまま（Lv.は変わらない）
- 目標内容のみが新しい内容に静かに切り替わる（例：「中級：120分」→「中級：90分」）
- バーはリセットされず、次の期間のデータから継続して伸びていく

### ビジネスロジック（目標変更ルール）

**目標の独立性:**
- Bronze（初級）、Silver（中級）、Gold（上級）の各目標は**完全に独立して管理される**
- それぞれの目標が個別に14日連続達成または7日中4日未達の条件を満たした場合、その目標のみが変更される
- 例：Bronzeが14日連続達成でレベルアップしても、SilverとGoldは変更されない

**レベルの管理:**
- 各目標レベル（Bronze/Silver/Gold）は独立したレベル（Lv.）を持つ
- 14日連続達成ごとにそのレベルのLv.が1つ上がり、目標内容が更新される
- レベルダウン（7日中4日未達）時は、レベルは横ばいのまま、目標内容のみが調整される

**目標変更のタイミング:**
- 目標編集画面で「更新ボタン」を押した瞬間に、変更対象の目標の現在の期間が確定
- 新しい期間が開始され、デッドヒート画面のアニメーションデータに反映される
- 変更されなかった目標は、前の期間が継続される

**目標変更の前提条件:**
- 提案バナー経由でのみ目標編集画面へアクセス可能
- **レベルアップ提案時**: 14日連続達成した目標のみ編集可能
  - 例：Goldを14日連続達成した場合、Gold目標のみ編集可能
- **レベルダウン提案時**: 7日中4日未達の場合、全目標の編集が可能

---

## 6. カレンダー画面（Monthly Overview）

過去の頑張りを振り返るための画面です。

- **月次カレンダー**:

    - **日付セル**: 達成度に応じたカラー（銅・銀・金）で塗りつぶし、またはドットを表示。

    - **リカバリーマーク**: Recovery達成日には特別なマーク（♥️）を表示。

    - **ホバーツールチップ**: 日付にマウスを乗せると「その日の目標」と「日報の冒頭」をポップアップ表示。

- **凡例**: 画面上部に「♥️マークはリカバリーモードで達成した日」と説明を記載。

- **詳細リンク**: 日付クリックで、その日の「日詳細画面（読み取り専用）」へ。

### 日詳細画面（読み取り専用）

カレンダーから遷移する、過去の記録を閲覧する画面です。

- **表示内容**: その日の記録・日報画面で入力した全ての内容を表示
    - 日付
    - 達成度（Bronze/Silver/Gold）
    - Recovery達成情報（Recovery達成日のみ表示、♥️マーク付き）
    - 達成したTODO一覧（目標TODO＋その他TODO）
      - 各TODOは達成/未達成の状態で表示
      - Recovery/Gold/Silver/Bronze/その他のカテゴリごとにグループ化
    - 自由記述（Journal）

- **編集不可**: 確定後の記録は編集できず、読み取り専用として表示される。
    

---

## 6. 履歴画面（History）

学習記録の履歴を、折れ線グラフと棒グラフを組み合わせた可視化で表示する画面です。目標のレベル変遷と達成状況を一目で把握できます。

### アクセス方法

- サイドバーのメニュー項目「履歴」から遷移
- メニュー順序: ホーム → 記録 → カレンダー → 履歴 → 目標変遷 → 設定

### 画面構成要素

画面は上から順に以下の構成で配置されます：
1. 折れ線グラフ（達成状況の推移）
2. 日付横軸（期間ラベル付き）← 折れ線グラフと棒グラフの境目
3. 棒グラフ（目標レベルの履歴）

#### ① 折れ線グラフ（達成状況の推移）

**レイアウト:**
- **縦軸**: 達成レベル（Gold=3, Silver=2, Bronze=1の数値）
- **データ点**: 各日にどの達成レベル（Gold/Silver/Bronze）まで到達したかを点で表示し、線で結ぶ
  - Gold達成: 3
  - Silver達成: 2
  - Bronze達成: 1
  - 未記録: 0または点なし
- **注意**: 折れ線グラフ自体には日付軸を表示しない（日付軸は②に配置）

#### ② 日付横軸（期間ラベル付き）

**配置:**
- 折れ線グラフと棒グラフの**境目**に配置
- 画面中央部を横断する太めの横棒として表示

**日付軸:**
- 時系列で日付を表示
- 折れ線グラフと棒グラフの両方に対応する共通の横軸

**レベル変更期間の表示（`<->`形式）:**
- 目標のレベルアップ・ダウンが発生した期間を、日付横軸の**上**に`<->`のような区間として表示
- **`<`（左向き矢印）**: 期間の開始日に対応する位置に配置
- **`>`（右向き矢印）**: 期間の終了日に対応する位置に配置
- `<`と`>`を線で結び、その上部に評価ラベルを表示:
  - **Goldレベルアップ**: 「絶好調！」
  - **Silverレベルアップ**: 「そこそこの調子！」
  - **Bronzeレベルアップ**: 「習慣継続中！」
  - **レベルダウン**: 「不調気味...」
- 複数の期間が同時に表示される場合は、ラベルが重ならないよう上下に段をずらして配置

**縦線（レベル変更の区切り線）:**
- 目標のレベルが変更された日付に、グラフ全体（折れ線グラフと棒グラフの両方）を貫通する縦線を引く
- この縦線により、期間が視覚的に区切られる

#### ③ 棒グラフ（目標レベルの履歴）

**レイアウト:**
- **3本の横棒**: 上から順にGold、Silver、Bronzeを表す横棒グラフ
- **各棒の色**: Goal Typeに対応した色（Gold=金色、Silver=銀色、Bronze=銅色）
- **横軸**: 日付横軸（②）と共通

**各棒の構成（レベル期間ごとにセグメント分割）:**
- 日ごとではなく、**レベル（Lv.1, Lv.2など）の期間ごと**にセグメント分割
- 各セグメント内に`|Lv.1|Lv.2|Lv.3|`形式でレベル番号ラベルを表示
- 例：Goldの棒が「|Lv.1|Lv.2|Lv.3|」のように3つのセグメントに分かれ、Lv.1の期間、Lv.2の期間、Lv.3の期間を表す
- セグメントの幅は、そのレベルが有効だった期間（日数）に比例
- 画面中央の縦線が重なっているセグメント（レベル）の目標内容を左側に表示

**目標内容の表示（左側固定）:**
- 各棒の左側に、現在スクロール中の中央縦線の位置に対応する目標内容を表示
- 例：「Bronze Lv.2 朝散歩をする」「Silver Lv.1 1機能を完成させる」「Gold Lv.3 リファクタリングまで完了する」
- スクロールしても左側の表示は固定され、中央縦線の位置に応じて動的に更新される

#### ④ 中央縦線（現在表示中の日付）

**表示と動作:**
- 画面中央に固定された縦線を表示し、現在フォーカス中の日付を示す
- 左右にスクロールすることで、折れ線グラフと棒グラフを横にスライドさせ、異なる期間を閲覧できる
- 棒グラフ左側の目標内容表示は、この中央縦線の位置に対応する期間の目標を表示する

**初期表示:**
- ページを開いた時点では、今日の日付が中央縦線の位置に表示される
- ユーザーは現在の状態を一目で把握できる

#### ④ 表示期間とスクロール

**表示期間:**
- 全期間のデータを取得・表示する（キャッシュは後から実装予定）
- 初回はデータ取得に時間がかかる可能性があるが、全履歴を一度に閲覧可能

**スクロール操作:**
- 横スクロールにより、過去から現在までの任意の期間を閲覧可能
- スクロール中、中央縦線は固定され、グラフが左右に動く
- 棒グラフ左側の目標表示は、中央縦線の位置に応じて動的に更新される

### データ取得とビジネスロジック

#### 折れ線グラフのデータ（達成状況）

- **データソース**: `records`テーブル
- **判定方法**: 各日の`goal_type`（bronze/silver/gold）を取得し、その日に達成した最高レベルを判定
  - Gold達成: 3
  - Silver達成: 2
  - Bronze達成: 1
  - 未記録: データなし
- **レベル変更期間の判定**: `goal_level_history`テーブルから、レベル変更が発生した日付を取得し、期間を区切る
  - レベルアップ（14日連続達成）: 該当期間に「絶好調！」「そこそこの調子！」「習慣継続中！」のいずれかを表示
  - レベルダウン: 「不調気味...」を表示

#### 棒グラフのデータ（目標レベル履歴）

- **データソース**: `goal_level_history`テーブル（新規作成）
- **テーブル構造**:
  - `id`: UUID（主キー）
  - `user_id`: UUID（ユーザーID、外部キー）
  - `goal_type`: TEXT（bronze/silver/gold）
  - `level`: INTEGER（目標レベル、Lv.1, Lv.2...）
  - `goal_content`: TEXT（目標内容）
  - `started_at`: TIMESTAMP（この目標レベルが開始された日時）
  - `ended_at`: TIMESTAMP（この目標レベルが終了した日時、NULL=現在も継続中）
  - `change_reason`: TEXT（変更理由: initial/level_up/level_down）
- **データ取得方法**: `goal_level_history`テーブルから、goal_typeごとにレベル変更履歴を取得し、各レベルの期間を算出
- **棒グラフのセグメント生成**:
  - 各goal_type（gold/silver/bronze）について、レベル変更履歴からセグメントを生成
  - 各セグメントは `{level, started_at, ended_at, goal_content, width}` の情報を持つ
  - `width`はそのレベルが有効だった日数に比例したピクセル幅

#### 中央縦線の日付に対応する目標表示

- 中央縦線の位置（日付）から、その日に有効だった目標レベルと内容を`goal_level_history`テーブルから取得
- 棒グラフ左側に「Bronze Lv.X [目標内容]」の形式で表示
- スクロール時、中央縦線の位置が変わるたびに表示内容を更新

### グラフライブラリ

- **使用ライブラリ**: Recharts
- **理由**: React用のシンプルで宣言的なグラフライブラリで、折れ線グラフと棒グラフの組み合わせが容易

### インタラクション

- **横スクロール**: 全期間を左右にスクロールして閲覧可能
- **中央縦線の固定**: スクロール中も中央縦線は画面中央に固定され、グラフが動く
- **目標表示の動的更新**: 中央縦線の位置に応じて、棒グラフ左側の目標表示が動的に更新される
- **初回起動時**: 今日の日付が中央に表示され、現在の達成状況が一目でわかる
- **履歴がない場合**: 「まだ学習履歴がありません」と表示

### 注意事項

- **全期間表示**: 初回は全データを取得するため、データ量が多い場合は読み込みに時間がかかる可能性がある
- **キャッシュ実装**: 2回目以降の閲覧を高速化するため、将来的にReact Queryなどでキャッシュを実装予定
- **パフォーマンス**: データ量が増えた場合、仮想化やページネーションの導入も検討

---

## 7. 設定画面（Settings）

学習管理のルールを確認する画面です。

### リカバリー目標の編集

- **リカバリー目標**: 現在設定されているリカバリー目標を表示・編集
  - テキスト入力（1行）
  - 「保存」ボタンで更新
  - リカバリーモード中は編集不可（グレーアウト）
  - 最低1文字以上の入力が必要

### ルール確認

- **レベルアップ提案**: 同じレベルを14日連続で達成した場合、目標をレベルアップすることを提案します。
- **レベルダウン提案**: Bronze未達が4日以上続いた場合、目標をレベルダウンすることを提案します。無理のないペースで続けることが大切です。

### 注意事項

- **GitHub連携機能は実装しません**: 外部サービスとの連携は行わず、学習管理に集中したシンプルな設計とします。


---

### UX向上のための「カラーパレット」提案

PC画面で長時間見ても疲れず、かつ「達成感」を感じられる配色です。

|**状態**|**推奨カラー**|**イメージ**|
|---|---|---|
|**未達**|`#E5E7EB` (Gray 200)|背景に溶け込む控えめな色。|
|**Bronze**|`#CD7F32` (Bronze)|落ち着いた銅色。温かみのあるブラウン。|
|**Silver**|`#94A3B8` (Slate 400)|洗練された銀色。少し青みのあるグレー。|
|**Gold**|`#F59E0B` (Amber 500)|鮮やかな金色。最も目立つ、達成の象徴。|

---

## 8. ユーザーフロー

### 初回利用時のフロー

新規ユーザーが最初にアプリを利用する際の流れです。

1. **サインアップ画面にアクセス**
    - メールアドレスとパスワードを入力してアカウント作成

2. **メール確認**
    - Supabaseから送信された確認メールのリンクをクリック

3. **ログイン**
    - ログイン画面でメールアドレスとパスワードを入力

4. **初期目標設定画面へ自動遷移**
    - 初回ログイン時は目標が未設定のため、自動的に初期目標設定画面へ遷移
    - Bronze/Silver/Goldの3つの目標を入力

5. **ホーム画面へ遷移**
    - 目標保存後、自動的にホーム画面へ遷移
    - 学習記録を開始できる状態になる

---

## 9. 日常的なユーザーフロー

### 毎日のサイクル

ユーザーが毎日通る基本的な流れです。

1. **記録画面へアクセス**
    - ヘッダーの「記録ボタン」から記録画面へ遷移

2. **その日の成果を記録**
    - 各レベル（Gold/Silver/Bronze）のTODOをチェック
    - 必要に応じて「その他」にTODOを追加してチェック
    - 自由記述で振り返りを記入（任意）

3. **記録を確定**
    - 「記録を確定してロックする」ボタンを押下
    - 記録が読み取り専用になり、ダッシュボードへ遷移

4. **過去の記録を振り返る**
    - ダッシュボードで過去の学習履歴を確認
    - カレンダー画面で月次の達成状況を俯瞰

### 目標調整のフロー

1. **提案バナーの表示**
    - レベルアップ条件達成時（14日連続達成）
    - レベルダウン提案時（7日中4日未達）

2. **目標編集画面へ遷移**
    - 提案バナーのボタンから目標編集画面へ

3. **目標を更新**
    - 新しい目標TODOリストを編集
    - 更新ボタンで保存

---

## 9. リカバリーモード（Recovery Mode）

「今日はBronzeの達成も無理だ」と感じた時に起動するモード。リカバリー目標を達成することで、不調が長引かないようにするための回復支援機能です。

### 概要

- **目的**: 調子が悪い日でもストリークを維持し、明日以降に不調が長引かないようにする
- **対象**: Bronze達成も難しいと感じた日

### リカバリー目標の設定

- **形式**: 1つのシンプルな目標（TODOリストではなく1つの文章）
  - 例: 「サウナに行く」「散歩に行く」「30分瞑想する」
- **初期設定**: 初期目標設定画面でBronze/Silver/Goldと一緒に設定
- **編集**: 設定画面からいつでも編集可能（リカバリーモード中を除く）
- **未設定時の挙動**: リカバリー目標が未設定の場合、アプリ起動時に設定を求める

### アクセス・起動条件

- **起動ボタンの配置**: ヘッダーの「記録」ボタンの横に「リカバリー」ボタンを配置
- **表示条件**: 当日の記録が未確定の場合のみ表示（記録確定後は非表示）
- **起動制限**: 1日1回のみ起動可能、キャンセル不可

### 起動確認ダイアログ

起動ボタン押下時に確認ダイアログを表示:

- **タイトル**: 「リカバリーモードを起動しますか？」
- **内容**:
  - 「あなたの目標：[設定したリカバリー目標]」
  - 「起動後はキャンセルできません」（注意事項）
- **ボタン**: 「起動する」「やめる」

### リカバリーモード中の表示

**ホーム画面:**
- 画面上部に控えめなバナーを固定表示
- バナー内容: 「リカバリーモード中：[リカバリー目標]」
- 記録画面への誘導リンクを含む

### 記録画面での扱い

- **Recoveryセクション**: 記録画面の最上部（Goldの上）に表示
- **表示条件**: リカバリーモードが起動中の場合のみ表示
- **内容**: ユーザーが設定したリカバリー目標を1つ表示
- **チェック動作**: チェックを入れるとRecovery達成として記録される

### 達成レベルと記録

- **Recovery + 通常レベル両方を記録**:
  - Recovery達成でストリーク維持
  - さらにBronze以上を達成した場合は、そのレベルも記録
- **達成レベル表記**:
  - Recoveryのみ達成: 「Recovery」
  - Recovery + Bronze達成: 「Recovery + Bronze」のように両方表示

### 特別な褒め文言（固定）

- **Recoveryのみ達成時**: 「今日はゆっくり休んで、明日に備えましょう！」
- **Recovery + Bronze以上達成時**: 「調子が悪い日なのによく頑張りました！踏ん張れたことには大きな意味があります。」

### カレンダー・履歴画面での表示

- **リカバリーマーク**: Recovery達成日には特別なマーク（♥️）を表示
- **凡例**: 画面上部に「♥️マークはリカバリーモードで達成した日」と説明を記載
- **達成レベルの色**: 通常のBronze/Silver/Goldの色はそのまま表示

### 日付変更時の挙動

- **リカバリーモード自動解除**: 日付が変わるとモードは自動的に解除される
- **記録なし**: Recovery未達成のまま日付が変わった場合、その日の記録にRecoveryは含まれない

### 編集制限

- **リカバリーモード中**: リカバリー目標の編集は不可（設定画面でグレーアウト）
- **リカバリーモード外**: 設定画面からいつでも編集可能