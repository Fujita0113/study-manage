# Requirements.md 改善計画

## 目的
現行のrequirements.mdに不足している仕様を補完し、実装に必要な情報を明確化する。

---

## 不足項目リスト

### 1. データモデル・スキーマの定義 【優先度: 高】

#### DoD（Definition of Done）
**成果物:** `docs/data-model.md` を新規作成

**完了条件:**
- [x] 以下のエンティティについてTypeScript型定義を記載
  - `User`（GitHub設定を含む）
  - `Goal`（Bronze/Silver/Gold の3レベル分）
  - `DailyRecord`（日次記録）
  - `Effort`（工夫）
  - `EffortEvaluation`（工夫の評価）
  - `Achievement`（達成度：Bronze/Silver/Gold）※DailyRecord.achievement_levelとして実装
  - `Streak`（ストリーク情報）
- [x] エンティティ間のリレーションシップをMermaid ERD形式で図示
- [x] データ永続化の方法を決定し記載（Supabaseを採用）
- [x] 各フィールドについて以下を記載
  - 型（string, number, Date, enum等）
  - 必須/任意
  - デフォルト値（ある場合）
  - バリデーションルール（最大文字数、数値範囲等）
- [x] `requirements.md` の冒頭に「データモデル詳細は [data-model.md](./data-model.md) を参照」と追記

#### 検討ポイント（解決済み）
- ✅ 工夫（Effort）は目標レベル（Bronze/Silver/Gold）のどれか1つに紐づくが、そのリレーションをどう表現するか
  - **決定**: レベルごとに独立した工夫セットを管理。`Effort.goal_level` フィールドで論理的に参照。
- ✅ 日次記録（DailyRecord）と工夫の評価の紐づけ方
  - **決定**: `EffortEvaluation` テーブルで両者を中間テーブル的に紐づけ。
- ✅ 過去データの参照効率（カレンダー表示時など）
  - **決定**: Supabase のインデックス機能を活用（`(user_id, date)` にUNIQUE制約兼インデックス）。

---

### 2. 工夫（Effort）の状態遷移の明確化 【優先度: 高】

#### DoD（Definition of Done）
**成果物:** `docs/effort-state-transitions.md` を新規作成

**完了条件:**
- [ ] 工夫のステータス列挙型（enum）を定義
  - 例: `active`, `scheduled`, `archived` など
  - 各ステータスの定義を日本語で説明
- [ ] Mermaid形式の状態遷移図を記載
  - すべての状態とその遷移条件を図示
  - 「再開初日」の扱いを含める
- [ ] 状態別の表示・編集可否マトリクスを表形式で作成
  - 行: ステータス（active, scheduled, archived等）
  - 列: 画面（記録・日報画面のCHECK, ACT, 工夫管理画面等）
  - セル: 表示可/不可、編集可/不可
- [ ] 「改良して継続」を選択した場合の処理方針を明記
  - 新規作成か、履歴保持か
- [ ] `requirements.md` の「7. 工夫管理画面」セクションに「詳細は [effort-state-transitions.md](./effort-state-transitions.md) を参照」と追記

#### 検討ポイント
- 「継続中」と「継続予定（明日から適用）」の違いをステータス名で明確化
- 「改良して継続」を選択した場合、新しい工夫として複製するのか、同一IDで履歴を持つのか
- アーカイブされた工夫を再開する際のデータの扱い

---

### 3. GitHub連携の詳細仕様 【優先度: 中】

#### DoD（Definition of Done）
**成果物:** `requirements.md` の「2. ホーム画面」内の「GitHubコミット履歴」サブセクションを拡充

**完了条件:**
- [ ] `requirements.md` の該当箇所に以下を追記
  - 使用するGitHub API: `GET /repos/{owner}/{repo}/commits`（具体的なエンドポイント）
  - 必要なスコープ: `repo`（プライベートリポジトリ対応）または `public_repo`（パブリックのみ）
  - フェッチタイミング: 「初回ロード時 + 手動更新ボタン押下時」と明記
  - 表示件数: 「直近10件」などの具体的な数値
  - エラーハンドリング方針:
    - 401/403: 「認証エラー。設定画面でトークンを確認してください」
    - 404: 「リポジトリが見つかりません」
    - 429 (Rate Limit): 「APIレート制限。しばらく待ってから再試行してください」
  - コミットメッセージのフィルタリング: 「すべて表示」or「Merge commitを除外」を決定し明記
- [ ] 複数リポジトリの扱い: 「v1では1リポジトリのみ対応。将来的に複数対応を検討」など方針を記載

#### 検討ポイント
- リポジトリが複数ある場合の扱い
- プライベートリポジトリへの対応
- コミットメッセージのフィルタリング（例: Merge commitを除外するか）

---

### 4. ストリークカウントロジックの詳細 【優先度: 中】

#### DoD（Definition of Done）
**成果物:** `docs/business-logic.md` を新規作成し、`requirements.md` から参照

**完了条件:**
- [ ] `docs/business-logic.md` に「ストリーク計算ロジック」セクションを作成し、以下を記載
  - 「記録をしなかった日」の定義: 「ローカル時刻の23:59:59までに記録を確定しなかった場合」
  - タイムゾーン: 「ユーザーのブラウザのローカル時刻を使用」
  - ストリークカウント対象: 「Bronze以上（Bronze, Silver, Gold のいずれか）を達成した日」
  - ストリークリセット条件: 「1日でも記録なし、またはBronze未達成の日があった場合、翌日カウントは0にリセット」
  - 計算アルゴリズム: 疑似コードまたはフローチャートで記載
- [ ] `requirements.md` の「1. 共通レイアウト」のストリーク表示部分に「計算ロジックの詳細は [business-logic.md](./business-logic.md) を参照」と追記

#### 検討ポイント
- 日付変更線をまたぐ場合の扱い
- アプリを数日間開かなかった場合の挙動

---

### 5. レベルアップ/ダウン提案の判定ロジック詳細 【優先度: 中】

#### DoD（Definition of Done）
**成果物:** `docs/business-logic.md` の「提案ロジック」セクションを追加

**完了条件:**
- [ ] `docs/business-logic.md` に「レベルアップ/ダウン提案判定ロジック」セクションを追加し、以下を記載
  - **14日連続達成の定義**: 「直近の記録日から過去に遡って連続14日間、該当レベル以上を達成している」
  - **レベルダウン提案の定義**: 「直近7日間のうち、Bronze未達成（記録なし含む）が4日以上」
  - **複数条件同時満足時の優先度**: 「Gold > Silver > Bronze の順。最も高いレベルの提案のみ表示」
  - **提案の非表示ロジック**: 「ユーザーが提案バナーを閉じた場合、次に条件を満たすまで非表示」
  - 判定アルゴリズム: 疑似コードまたはフローチャートで記載
- [ ] `requirements.md` の「2. ホーム画面 > B. ダッシュボード > 提案バナー」部分に「判定ロジックの詳細は [business-logic.md](./business-logic.md#提案ロジック) を参照」と追記

#### 検討ポイント
- 提案を無視し続けた場合のリマインド戦略
- 提案を一度却下したら一定期間表示しないなどの制御

---

### 6. エラー状態・エッジケースの仕様 【優先度: 中】

#### DoD（Definition of Done）
**成果物:** `requirements.md` に新規セクション「9. エラーハンドリング・エッジケース」を追加

**完了条件:**
- [ ] `requirements.md` に「## 9. エラーハンドリング・エッジケース」セクションを新規作成し、以下を記載
  - **初回利用時のフロー**:
    - 初回アクセス時に「目標設定ウィザード」を表示
    - Bronze/Silver/Goldの3つの目標を入力させる
    - サンプルデータの有無: 「v1ではサンプルなし。ユーザー自身で入力」
  - **データ不整合時の挙動**:
    - 工夫が参照する目標レベルが存在しない: 「該当工夫を表示せず、コンソールに警告ログ出力」
    - 日次記録の日付が重複: 「最新のタイムスタンプを持つ記録を採用」
  - **日付巻き戻し時**: 「システム日付が過去に戻った場合、警告を表示し記録を許可しない」
  - **データクリア時**: 「初回利用時と同じフローに戻る」
- [ ] データのバックアップ機能の方針を記載: 「v1では未実装。将来的にJSON形式でのエクスポート/インポート機能を検討」

#### 検討ポイント
- データのバックアップ・エクスポート機能の必要性
- マイグレーション戦略（将来のスキーマ変更時）

---

### 7. UI/UXの細部仕様 【優先度: 低】

#### DoD（Definition of Done）
**成果物:** `requirements.md` に新規セクション「10. UI/UX詳細仕様」を追加

**完了条件:**
- [ ] `requirements.md` に「## 10. UI/UX詳細仕様」セクションを新規作成し、以下を記載
  - **ローディング状態**: 「Spinner + 『読み込み中...』テキスト表示。GitHub API呼び出し時など」
  - **フィードバック方法**: 「トースト通知（成功: 緑、エラー: 赤、警告: 黄）。モーダルは削除確認時のみ使用」
  - **モバイル対応**: 「v1ではデスクトップ優先。レスポンシブ対応は将来検討」
  - **アクセシビリティ**: 「v1では基本的なセマンティックHTML使用。WAI-ARIA対応は将来検討」
  - **ダークモード**: 「v1では未対応」
  - **アニメーション**: 「控えめに使用（フェードイン/アウト程度）。パフォーマンス優先」

#### 検討ポイント
- ダークモード対応の有無
- アニメーション・トランジションの方針

---

### 8. 記録・日報画面の入力バリデーション 【優先度: 低】

#### DoD（Definition of Done）
**成果物:** `requirements.md` の「3. 記録・日報画面」セクションに「入力バリデーション」サブセクションを追加

**完了条件:**
- [ ] `requirements.md` の「## 3. 記録・日報画面」の末尾に「### 5. 入力バリデーション」サブセクションを追加し、以下を記載
  - **文字数制限**:
    - 工夫の内容: 200文字
    - 理由・改良案: 500文字
    - Step-Up Strategy: 500文字
    - 自由記述（Journal）: 2000文字
  - **必須/任意フィールド**:
    - 必須: 達成度の選択（Bronze/Silver/Gold）
    - 任意: すべてのテキスト入力フィールド
  - **バリデーションエラー表示**: 「フィールド下部に赤文字でエラーメッセージ表示」
  - **保存前確認**: 「確認ダイアログなし。即座に保存・ロック」
  - **下書き保存**: 「v1では未実装」
  - **ページ離脱警告**: 「未保存の内容がある場合、ブラウザ標準の警告を表示」

#### 検討ポイント
- 下書き保存機能の必要性
- 入力途中でのページ離脱時の警告

---

## 実施スケジュール（案）

### Phase 1: データ設計の明確化（最優先）
1. データモデル・スキーマの定義
2. 工夫の状態遷移の明確化

### Phase 2: ビジネスロジックの詳細化
3. ストリークカウントロジック
4. レベルアップ/ダウン提案の判定ロジック

### Phase 3: 外部連携・エラー処理
5. GitHub連携の詳細仕様
6. エラー状態・エッジケースの仕様

### Phase 4: UI/UX の洗練
7. UI/UXの細部仕様
8. 入力バリデーション

---

## 次のアクション

1. **データモデル定義書の作成**
   - `docs/data-model.md` を新規作成
   - TypeScript型定義も含めて記載

2. **状態遷移図の作成**
   - `docs/effort-state-diagram.md` を新規作成
   - Mermaid形式で視覚化

3. **ビジネスロジック詳細の追記**
   - `docs/business-logic.md` を新規作成
   - ストリーク計算、提案判定などのアルゴリズムを疑似コードで記載

4. **requirements.md の改訂**
   - 上記の新規ドキュメントへの参照を追加
   - 既存の曖昧な表現を明確化
