# Supabase接続エラー調査計画

## エラー概要

ホーム画面でSupabaseからデータ取得時に以下のエラーが発生:

```
Failed to fetch daily records: {
  code: '22P02',
  details: null,
  hint: null,
  message: 'invalid input syntax for type uuid: "mock-user-001"'
}
```

**エラーコード `22P02`**: PostgreSQLのinvalid_text_representation（不正なテキスト形式）エラー

---

## 調査の目的

1. **MOCK_USER_IDの実際の値を特定する**
   - [app/page.tsx:42](app/page.tsx#L42)で`getDailyRecords(MOCK_USER_ID)`を呼び出している
   - 実際にどの値が渡されているか確認

2. **Supabaseに存在するuser_idを確認する**
   - データベースに実際に存在するuser_idの値を取得
   - 期待値(`00000000-0000-0000-0000-000000000001`)と一致するか確認

3. **型変換の問題がないか確認する**
   - Server ComponentからClient関数への値の受け渡し
   - Supabase SSRクライアントの挙動

---

## 調査ステップ

### ステップ1: ランタイムでの値確認スクリプト作成

**目的**: 実際に実行時にどの値が使用されているか確認する

**作成ファイル**: `scripts/debug-mock-user-id.ts`

このスクリプトで以下を確認:
- `MOCK_USER_ID`の実際の値
- その値の型（string/UUID）
- インポートチェーンの確認

### ステップ2: Supabaseデータベースの実データ確認

**目的**: データベースに実際にどのuser_idが存在するか確認

**作成ファイル**: `scripts/check-database-user-ids.ts`

このスクリプトで以下を確認:
- `daily_records`テーブルに存在する全user_id
- `user_settings`テーブルに存在する全user_id
- UUID形式が正しいか

### ステップ3: 統合デバッグスクリプト実行

**目的**: 本番環境と同じコンテキストでgetDailyRecordsを呼び出す

**作成ファイル**: `scripts/test-homepage-data-fetch.ts`

このスクリプトで以下を確認:
- ホーム画面と同じロジックでデータ取得
- エラーの再現
- 詳細なエラー情報の取得

---

## 想定される原因と対策

### 原因1: キャッシュされた古い値
**症状**: コードは正しいが、ビルドキャッシュに古い値が残っている
**対策**:
```bash
rm -rf .next
npm run build
npm run dev
```

### 原因2: 環境変数の問題
**症状**: サーバーサイドで環境変数が読み込まれていない
**対策**:
- `.env.local`の確認
- サーバー再起動

### 原因3: データベースにテストデータが存在しない
**症状**: UUID形式は正しいが、そのuser_idのデータがない
**対策**:
- テストデータ再投入スクリプトの実行

### 原因4: Server Component/Client Componentの境界での型変換
**症状**: Server ComponentからClient関数への値渡し時に型が変わる
**対策**:
- 値の渡し方を見直す
- シリアライゼーション処理の確認

---

## 調査の優先順位

1. **最優先**: ステップ2（データベース実データ確認）
   - データが存在しない可能性が最も高い

2. **次点**: ステップ1（ランタイム値確認）
   - コード上の値とランタイムの値の不一致確認

3. **最後**: ステップ3（統合テスト）
   - 上記2つで原因が特定できない場合

---

## 成功の判断基準

以下のすべてが確認できれば調査完了:

1. ✅ MOCK_USER_IDの値が`00000000-0000-0000-0000-000000000001`である
2. ✅ Supabaseの`daily_records`テーブルにこのuser_idのデータが存在する
3. ✅ `getDailyRecords(MOCK_USER_ID)`が正常にデータを返す
4. ✅ ホーム画面でエラーが発生しない

---

## 次のアクション

調査完了後、原因に応じて以下のいずれかを実施:

### パターンA: データが存在しない場合
→ テストデータ投入スクリプトを作成・実行

### パターンB: MOCK_USER_IDの値が間違っている場合
→ 正しい値に修正

### パターンC: Server/Clientの型変換問題の場合
→ データ取得ロジックをリファクタリング

### パターンD: その他の原因の場合
→ 詳細な修正計画を別途作成
