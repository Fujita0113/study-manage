# 目標変遷画面（/history）UIデザイン変更 実装計画書

## 変更の概要

目標変遷画面のUIを、「3つの目標を1枚のカードにまとめた表示」から「各目標を独立したカードとして表示」する形式に変更します。これにより、Bronze/Silver/Goldの各目標が独立して変更される仕様を、より直感的に可視化できるようになります。

---

## 変更の目的

1. **目標の独立性を視覚的に表現**: 各目標レベル（Bronze/Silver/Gold）が独立して管理されることを、UIで明確に表現する
2. **変更タイミングの可視化**: 各目標がいつ変更されたのかを、時間軸上で正確に把握できるようにする
3. **レベルアップ・ダウンの明確化**: どの目標がレベルアップまたはダウンしたのかを、矢印を使って明示する
4. **モックデータの充実**: レベルアップ・ダウンの両方の矢印が見えるモックデータを用意し、UIの動作確認を容易にする

---

## 要件定義の変更内容

[docs/requirements.md](./requirements.md)の「5. 目標変遷画面（Goal History Timeline）」セクションを更新しました。

### 主な変更点:

1. **カード表示の変更**:
   - 旧: 1つのスロット（カード）に3つの目標をまとめて表示
   - 新: 各目標レベル（Bronze/Silver/Gold）を個別のカードとして表示

2. **レイアウト**:
   - 時系列方向: 横スクロール（左→右）
   - カード配置: 各時点でBronze → Silver → Goldの順に縦に積み重ねて表示
   - 時間軸での整列: 横軸を共通の時間軸として、各目標カードを開始日・終了日に応じて配置
   - 目標ごとに期間が異なる場合、カードが横方向にずれて表示される

3. **矢印の表示**:
   - 各目標カードの間に個別に配置
   - Bronze、Silver、Goldそれぞれが独立して矢印を持つことができる

4. **現在進行中の目標**:
   - 3つの目標すべてに鍵マークアイコンと進捗インジケーターを表示
   - 各目標レベルごとに個別に連続達成日数を表示

---

## データモデルの変更

### 現在のデータ構造

現在の`GoalSlot`型は、3つの目標を1つのスロットにまとめています:

```typescript
type GoalSlot = {
  id: string
  goals: {
    bronze: string
    silver: string
    gold: string
  }
  startDate: string
  endDate: string | null  // nullの場合は現在進行中
}
```

### 新しいデータ構造（提案）

各目標レベルを独立して管理するため、以下の構造を提案します:

```typescript
type GoalLevel = 'bronze' | 'silver' | 'gold'

type TransitionType = 'level_up' | 'level_down' | null

type GoalCard = {
  id: string
  level: GoalLevel
  content: string
  startDate: string
  endDate: string | null  // nullの場合は現在進行中
  transitionType: TransitionType  // 次のカードへの遷移タイプ
  currentStreak?: number  // 現在進行中のカードのみ（Bronze/Silver/Goldそれぞれで管理）
}

type GoalHistory = {
  bronze: GoalCard[]
  silver: GoalCard[]
  gold: GoalCard[]
}
```

**注意**: この構造変更により、既存のコードへの影響範囲が広くなる可能性があります。段階的な移行も検討する必要があります。

---

## UI実装の詳細

### 1. レイアウト構造

```
┌─────────────────────────────────────────────────────────────┐
│                     目標変遷画面                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  [横スクロール領域]                                           │
│                                                               │
│  過去 ←──────────────────────────────────────→ 現在         │
│                                                               │
│  ┌─────┐  ↗️  ┌─────┐     ┌─────┐  🔒              │
│  │Bronze│ 14日 │Bronze│     │Bronze│ 7/14日           │
│  │カード│ 達成 │カード│     │カード│                    │
│  └─────┘     └─────┘     └─────┘                    │
│                                                               │
│  ┌─────┐     ┌─────┐  ↘️  ┌─────┐  🔒              │
│  │Silver│     │Silver│ 調整 │Silver│ 10/14日          │
│  │カード│     │カード│     │カード│                    │
│  └─────┘     └─────┘     └─────┘                    │
│                                                               │
│  ┌─────┐     ┌─────┐     ┌─────┐  🔒              │
│  │ Gold │     │ Gold │     │ Gold │ 5/14日           │
│  │カード│     │カード│     │カード│                    │
│  └─────┘     └─────┘     └─────┘                    │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 2. カードの表示内容

各カードには以下を表示:

1. **目標レベル**: Bronze / Silver / Gold のラベル（色分け）
2. **目標内容**: 具体的な内容（例：「毎日20分ランニング」）
3. **実施期間**: 開始日〜終了日（例：2026/01/01 - 2026/01/14）
4. **カード幅**: 期間の長さに比例（例：14日 = 200px、30日 = 400px）
5. **現在進行中の表示**（最新のカードのみ）:
   - 🔒 鍵マークアイコン
   - 進捗インジケーター（例：「7日 / 14日」）

### 3. 矢印の表示

カード間に以下の矢印を表示:

- **レベルアップ矢印 (↗️)**:
  - 色: 青または緑
  - ラベル: 「14日連続達成」
  - 表示条件: その目標レベルで14日間連続達成時

- **レベルダウン矢印 (↘️)**:
  - 色: 赤またはオレンジ
  - ラベル: 「目標調整」
  - 表示条件: その目標レベルで7日中4日未達時

### 4. 時間軸での整列

- 横軸を共通の時間軸として使用
- 各カードの開始位置は、開始日に基づいて計算
- カード幅は、(終了日 - 開始日) に比例
- 目標ごとに期間が異なる場合、カードが横方向にずれて表示される

例:
```
時間軸: 2026/01/01 ──────────────────────────── 2026/02/01

Bronze:  [────カード1────][────カード2────]
Silver:  [──────カード1──────────][─カード2─]
Gold:    [─────────────カード1─────────────]
```

---

## モックデータの設計

### 要件

- 履歴スロット数: 6〜10回程度
- パターン:
  1. **Bronzeのみ変更**: Bronzeがレベルアップまたはダウン、Silver/Goldは変更なし
  2. **複数同時変更**: 同じタイミングで複数の目標（例：BronzeとSilver）が変更される
- レベルアップ・ダウンの両方の矢印が見えること

### モックデータ例（概要）

```
スロット1: 2025/12/01 - 2025/12/14
  - Bronze: 「机に座る」
  - Silver: 「1機能完成」
  - Gold: 「リファクタまで完了」

スロット2: 2025/12/15 - 2025/12/28 (Bronze のみレベルアップ)
  - Bronze: 「30分集中」 ← レベルアップ矢印 (↗️)
  - Silver: 「1機能完成」 (継続)
  - Gold: 「リファクタまで完了」 (継続)

スロット3: 2025/12/29 - 2026/01/05 (Silver もレベルアップ)
  - Bronze: 「30分集中」 (継続)
  - Silver: 「2機能完成」 ← レベルアップ矢印 (↗️)
  - Gold: 「リファクタまで完了」 (継続)

... 以降、レベルダウンのパターンも含める
```

詳細なモックデータは、`lib/mockData.ts`で実装します。

---

## 実装の影響範囲

### 1. データモデル (`types/index.ts`)

- 新しい型定義: `GoalCard`, `GoalHistory`, `TransitionType`
- 既存の`GoalSlot`型との互換性を考慮

### 2. モックデータ (`lib/mockData.ts`)

- 新しいモックデータの作成
- レベルアップ・ダウンのパターンを含む6〜10個の履歴データ

### 3. ストア (`lib/store.tsx`)

- `GoalHistory`を管理する状態の追加
- 既存の`goalSlots`との関係を整理

### 4. 画面コンポーネント (`app/history/page.tsx`)

- 完全なUI再設計
- 横スクロール実装
- 時間軸ベースのレイアウト計算
- カードコンポーネントの実装

### 5. カードコンポーネント (`components/history/GoalCard.tsx` - 新規)

- 個別の目標カードの表示
- 鍵マーク、進捗インジケーターの表示

### 6. 矢印コンポーネント (`components/history/TransitionArrow.tsx` - 新規)

- レベルアップ・ダウン矢印の表示
- 条件に基づいた表示制御

---

## 実装手順（推奨）

### Phase 1: データモデルとモックデータの準備

1. `types/index.ts`に新しい型定義を追加
2. `lib/mockData.ts`で新しいモックデータを作成
3. `lib/store.tsx`に`GoalHistory`を管理する状態を追加

### Phase 2: UIコンポーネントの実装

4. `components/history/GoalCard.tsx`の作成（個別カード表示）
5. `components/history/TransitionArrow.tsx`の作成（矢印表示）
6. `components/history/TimelineContainer.tsx`の作成（横スクロール、時間軸レイアウト）

### Phase 3: 画面の統合

7. `app/history/page.tsx`の全面的な書き換え
8. 時間軸ベースのレイアウト計算ロジックの実装
9. 横スクロールの実装と初期表示位置の設定

### Phase 4: テストと調整

10. 各パターン（レベルアップ・ダウン、Bronzeのみ変更、複数同時変更）の動作確認
11. レスポンシブデザインの調整
12. パフォーマンスの最適化

---

## 技術的な考慮事項

### 1. 時間軸ベースのレイアウト計算

各カードの横方向の位置とサイズを、期間に基づいて計算する必要があります:

```typescript
// 例: 日数をピクセルに変換
const PIXELS_PER_DAY = 10  // 1日あたり10px

function calculateCardPosition(startDate: string, baseDate: string): number {
  const daysDiff = differenceInDays(parseISO(startDate), parseISO(baseDate))
  return daysDiff * PIXELS_PER_DAY
}

function calculateCardWidth(startDate: string, endDate: string | null): number {
  if (!endDate) {
    // 現在進行中の場合は、今日までの日数
    return differenceInDays(new Date(), parseISO(startDate)) * PIXELS_PER_DAY
  }
  return differenceInDays(parseISO(endDate), parseISO(startDate)) * PIXELS_PER_DAY
}
```

### 2. 横スクロールの実装

```tsx
<div className="overflow-x-auto">
  <div style={{ width: `${totalWidth}px` }}>
    {/* カードを配置 */}
  </div>
</div>
```

### 3. 初期表示位置の設定

最新のカード（一番右）が画面右端に表示されるよう、初期スクロール位置を設定:

```typescript
useEffect(() => {
  const container = scrollContainerRef.current
  if (container) {
    container.scrollLeft = container.scrollWidth - container.clientWidth
  }
}, [])
```

### 4. レスポンシブ対応

- PC画面で最適な表示を優先
- 必要に応じて`PIXELS_PER_DAY`を画面幅に応じて調整

---

## デザインガイドライン

### カラーパレット

- **Bronze**: `#CD7F32` (Bronze)
- **Silver**: `#94A3B8` (Slate 400)
- **Gold**: `#F59E0B` (Amber 500)
- **レベルアップ矢印**: `#10B981` (Green 500) または `#3B82F6` (Blue 500)
- **レベルダウン矢印**: `#EF4444` (Red 500) または `#F97316` (Orange 500)

### カードのスタイリング

- 角丸: `rounded-lg`
- シャドウ: `shadow-md`
- ボーダー: 目標レベルに応じた色
- パディング: `p-4`

### 矢印のスタイリング

- 太さ: 2〜3px
- 長さ: カード間の距離に応じて調整
- アイコン: `↗️` (レベルアップ), `↘️` (レベルダウン)

---

## 今後の拡張性

### 将来的な機能（現時点では実装不要）

1. **詳細表示**: カードをクリックすると、その期間の詳細情報（達成状況、日報など）を表示
2. **フィルタリング**: 特定の目標レベル（Bronze/Silver/Goldのいずれか）のみを表示
3. **統計情報**: レベルアップ・ダウンの回数、平均期間などを表示
4. **エクスポート**: 目標変遷の履歴をCSVやPDFで出力

---

## リスクと対策

### リスク1: データ移行の複雑さ

既存の`GoalSlot`型から新しい`GoalCard`型への移行が複雑になる可能性があります。

**対策**:
- 段階的な移行を検討
- 両方のデータ構造を一時的にサポート
- モックデータで先に新UIを実装し、その後データ移行を行う

### リスク2: パフォーマンス

履歴が増えた場合、レンダリングパフォーマンスが低下する可能性があります。

**対策**:
- 仮想スクロール（Virtual Scrolling）の導入を検討
- 初期表示は最新の50件程度に制限し、必要に応じて過去の履歴を読み込む
- React.memoを使用してカードコンポーネントの再レンダリングを最適化

### リスク3: レイアウトの複雑さ

時間軸ベースのレイアウト計算が複雑になり、バグが発生する可能性があります。

**対策**:
- レイアウト計算ロジックを独立した関数として実装し、ユニットテストを作成
- モックデータで様々なパターン（期間が異なる、重複する、など）をテスト

---

## まとめ

この実装計画書では、目標変遷画面のUIデザイン変更について、以下を定義しました:

1. **要件定義の更新**: `docs/requirements.md`の更新内容
2. **データモデルの変更**: 新しい`GoalCard`型と`GoalHistory`型の提案
3. **UI実装の詳細**: レイアウト、カード、矢印の表示仕様
4. **モックデータの設計**: 6〜10個の履歴データ、レベルアップ・ダウンのパターン
5. **実装手順**: Phase 1〜4の段階的な実装計画
6. **技術的な考慮事項**: 時間軸レイアウト、横スクロール、初期表示位置
7. **リスクと対策**: データ移行、パフォーマンス、レイアウトの複雑さ

次のステップとして、この計画書の内容について承認をいただき、Phase 1から実装を開始します。
